<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TAKT Public Beta</title>
  <style>
    :root { color-scheme: light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 0; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 28px 18px 60px; }
    header { margin-bottom: 18px; }
    h1 { margin: 0 0 8px; font-size: 28px; }
    p { margin: 6px 0; line-height: 1.45; }
    .card { border: 1px solid #e6e6e6; border-radius: 12px; padding: 16px; background: #fff; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
    label { font-weight: 600; display: block; margin-bottom: 8px; }
    textarea { width: 100%; min-height: 180px; padding: 12px; border-radius: 10px; border: 1px solid #d7d7d7; font-size: 14px; line-height: 1.4; resize: vertical; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    button { border: 0; border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer; }
    button.primary { background: #111; color: #fff; }
    button.ghost { background: #f2f2f2; color: #111; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .hint { font-size: 12px; color: #555; }
    .status { font-size: 13px; padding: 10px 12px; border-radius: 10px; border: 1px solid #e6e6e6; background: #fafafa; }
    pre { white-space: pre-wrap; word-wrap: break-word; margin: 0; font-size: 14px; line-height: 1.45; }
    .out { min-height: 140px; }
    .footer { margin-top: 14px; font-size: 12px; color: #666; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>TAKT Public Beta</h1>
      <p>Füge einen Kommentar ein. Du erhältst eine strukturierte Moderations- und Deeskalationsanalyse.</p>
      <p class="hint">Hinweis: Bitte keine sensiblen personenbezogenen Daten einfügen. Output kann Fehler enthalten.</p>
    </header>

    <div class="grid">
      <section class="card">
        <label for="input">Kommentar</label>
        <textarea id="input" placeholder="Kommentar hier einfügen…"></textarea>

        <div class="row" style="margin-top: 10px;">
          <button class="primary" id="run">Analysieren</button>
          <button class="ghost" id="example" type="button">Beispiel einsetzen</button>
          <span class="hint" id="counter">0 / 2.000 Zeichen</span>
        </div>

        <div class="footer">
          Endpoint: <span class="mono">/.netlify/functions/takt</span>
        </div>
      </section>

      <section class="card out">
        <div class="row" style="justify-content: space-between; margin-bottom: 10px;">
          <strong>Output</strong>
          <button class="ghost" id="copy" type="button" disabled>Copy</button>
        </div>

        <div class="status" id="status">Bereit.</div>
        <div style="height: 10px;"></div>
        <pre id="output"></pre>
      </section>
    </div>
  </div>

  <script>
    const MAX_CHARS = 2000;

    const input = document.getElementById("input");
    const runBtn = document.getElementById("run");
    const exampleBtn = document.getElementById("example");
    const copyBtn = document.getElementById("copy");
    const counter = document.getElementById("counter");
    const statusEl = document.getElementById("status");
    const outputEl = document.getElementById("output");

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function setOutput(text) {
      outputEl.textContent = text || "";
      copyBtn.disabled = !outputEl.textContent.trim();
    }

    function updateCounter() {
      const len = (input.value || "").length;
      counter.textContent = `${len} / ${MAX_CHARS} Zeichen`;
      if (len > MAX_CHARS) counter.textContent += " (zu lang)";
    }

    input.addEventListener("input", updateCounter);
    updateCounter();

    exampleBtn.addEventListener("click", () => {
      input.value = "Du hast ja absolut keine Ahnung. Typisch. Immer dieses Gelaber. Lern erstmal nachzudenken.";
      updateCounter();
      input.focus();
    });

    copyBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(outputEl.textContent);
        setStatus("Output kopiert.");
        setTimeout(() => setStatus("Bereit."), 1200);
      } catch {
        setStatus("Copy nicht möglich. Bitte manuell markieren.");
      }
    });

    runBtn.addEventListener("click", async () => {
      const text = (input.value || "").trim();

      if (!text) {
        setStatus("Bitte erst einen Kommentar einfügen.");
        setOutput("");
        return;
      }

      if (text.length > MAX_CHARS) {
        setStatus(`Text zu lang. Bitte auf maximal ${MAX_CHARS} Zeichen kürzen.`);
        setOutput("");
        return;
      }

      runBtn.disabled = true;
      copyBtn.disabled = true;
      setStatus("Analysiere…");
      setOutput("");

      try {
        const res = await fetch("/.netlify/functions/takt", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            text,
            mode: "website",
            options: {
              public_variants: 2,
              dm_variants: 0
            }
          })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          const msg = data && data.error ? data.error : `Fehler (${res.status})`;
          throw new Error(msg);
        }

        setOutput(data.output || "");
        setStatus("Fertig.");
      } catch (e) {
        setStatus("Fehler: " + (e?.message || String(e)));
        setOutput("");
      } finally {
        runBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
